{% extends 'base.html' %}

{% block title %}{{ article.title }} - Portal de Not√≠cias{% endblock %}

{% block content %}
<article class="bg-white rounded-lg shadow-lg p-8 mb-8">
    <h1 class="text-4xl font-bold mb-4">{{ article.title }}</h1>
    <div class="text-gray-600 mb-4">
        <span>Por {{ article.author.username }}</span> | 
        <span>{{ article.created_at|date:"d/m/Y H:i" }}</span> |
        <span>üëÅÔ∏è {{ article.views }} visualiza√ß√µes</span>
    </div>
    
    {% if article.image %}
        <img src="{{ article.image.url }}" alt="{{ article.title }}" class="w-full h-96 object-cover rounded mb-6">
    {% endif %}
    
    <div class="prose max-w-none mb-6">
        {{ article.content|safe }}
    </div>
    
    <div class="mb-6">
        <button onclick="toggleLike({{ article.id }})" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600" id="like-btn">
            ‚ù§Ô∏è <span id="like-count">{{ article.total_likes }}</span> Curtidas
        </button>
    </div>
    
    {% if article.tags.all %}
        <div class="mb-6">
            <strong>Tags:</strong>
            {% for tag in article.tags.all %}
                <span class="bg-gray-200 px-3 py-1 rounded-full text-sm">{{ tag.name }}</span>
            {% endfor %}
        </div>
    {% endif %}
    
    {% if map_html %}
        <div class="mb-6">
            <h3 class="text-2xl font-bold mb-4">Localiza√ß√£o</h3>
            {{ map_html|safe }}
        </div>
    {% endif %}
    
    {% if user.is_authenticated and user == article.author or user.profile.role == 'admin' %}
        <div class="space-x-2">
            <a href="{% url 'article_edit' article.slug %}" class="bg-yellow-500 text-white px-4 py-2 rounded hover:bg-yellow-600">Editar</a>
            <a href="{% url 'article_delete' article.slug %}" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600">Deletar</a>
        </div>
    {% endif %}
</article>

<div class="bg-white rounded-lg shadow-lg p-8">
    <h3 class="text-2xl font-bold mb-4">Coment√°rios</h3>
    
    {% if user.is_authenticated %}
        <form method="post" action="{% url 'add_comment' article.id %}" class="mb-6">
            {% csrf_token %}
            <textarea name="content" rows="3" class="w-full border rounded p-2" placeholder="Escreva seu coment√°rio..."></textarea>
            <button type="submit" class="mt-2 bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Comentar</button>
        </form>
    {% else %}
        <p class="mb-4"><a href="{% url 'login' %}" class="text-blue-600 hover:underline">Fa√ßa login</a> para comentar.</p>
    {% endif %}
    
    {% for comment in comments %}
        <div class="border-b pb-4 mb-4">
            <p class="font-bold">{{ comment.user.username }}</p>
            <p class="text-sm text-gray-500">{{ comment.created_at|date:"d/m/Y H:i" }}</p>
            <p class="mt-2">{{ comment.content }}</p>
            {% if user == comment.user or user.profile.role == 'admin' %}
                <a href="{% url 'delete_comment' comment.id %}" class="text-red-600 text-sm hover:underline">Deletar</a>
            {% endif %}
        </div>
    {% empty %}
        <p class="text-gray-500">Nenhum coment√°rio ainda.</p>
    {% endfor %}
</div>

<script>
function toggleLike(articleId) {
    fetch(`/article/${articleId}/like/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': '{{ csrf_token }}',
            'Content-Type': 'application/json',
        },
    })
    .then(response => response.json())
    .then(data => {
        document.getElementById('like-count').textContent = data.total_likes;
    });
}
</script>
{% endblock %}
